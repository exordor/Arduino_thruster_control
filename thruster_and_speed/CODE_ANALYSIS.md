# Arduino Thruster Control - 代码分析

> 生成日期: 2026-02-05
> 文件: `thruster_and_speed.ino`

---

## 概览

| 指标 | 数值 |
|---|---|
| **总行数** | 951 行 |
| **注释行** | ~80 行 (8.4%) |
| **空行** | ~120 行 (12.6%) |
| **实际代码** | ~751 行 (79.0%) |
| **函数数量** | 16 个 |
| **中断处理** | 2 个 |

---

## 按功能模块分布

| 模块 | 行数范围 | 行数 | 占比 | 主要职责 |
|---|---|---|---|---|
| **文件头与文档** | 1-26 | 26 | 2.7% | 协议文档、端口配置说明 |
| **配置与常量** | 27-219 | 193 | 20.3% | 网络、引脚、时序、状态变量 |
| **RC 控制函数** | 221-334 | 114 | 12.0% | PWM 捕获、档位映射、信号滤波 |
| **流量计函数** | 336-392 | 57 | 6.0% | 流量传感器轮询、数据计算 |
| **UDP 通信函数** | 394-575 | 182 | 19.1% | 命令接收、状态发送、心跳 |
| **WiFi 管理** | 577-814 | 238 | 25.0% | 多网络连接、自动重连 |
| **setup() 初始化** | 816-876 | 61 | 6.4% | 硬件初始化、网络连接 |
| **loop() 主循环** | 878-951 | 74 | 7.8% | 主控制循环 |

---

## 配置与常量细分 (193 行)

```
配置与常量 (193 行)
├── WiFi 配置          55 行   网络列表、重连参数、状态跟踪
├── UDP 配置            7 行   端口定义、缓冲区
├── Jetson 配置         5 行   固定目标 IP:端口
├── 引脚配置            5 行   RC 输入、ESC 输出引脚
├── 流量计配置          8 行   传感器引脚、计算参数
├── 时序常量            7 行   超时、发送间隔
├── ESC 配置            7 行   脉宽范围、死区
├── Gear 模式配置      32 行   9 档位定义、切换阈值
└── 状态变量           67 行   RC/WiFi/流量计状态
```

### WiFi 网络配置

支持最多 5 个 WiFi 网络，自动按优先级连接：

```cpp
// 当前配置的 3 个网络
1. IGE-Geomatics-sense-mobile    (192.168.50.100)
2. GL-MT1300-a42                 (192.168.50.100)
3. ISSE_2.4                      (192.168.50.100)
4. [可添加更多网络，最多 5 个]
```

### Gear 模式配置

9 档位控制模式（4 档倒车 | 中立 | 4 档前进）：

| 档位 | 脉宽 (µs) | 说明 |
|---|---|---|
| Gear 1 | 1100 | 倒车最大 |
| Gear 2 | 1200 | 倒车高速 |
| Gear 3 | 1300 | 倒车中速 |
| Gear 4 | 1400 | 倒车低速 |
| Gear 5 | 1500 | 中立停止 |
| Gear 6 | 1600 | 前进低速 |
| Gear 7 | 1700 | 前进中速 |
| Gear 8 | 1800 | 前进高速 |
| Gear 9 | 1900 | 前进最大 |

---

## 函数分布

### RC 控制 (4 函数, 114 行)

| 函数 | 行数 | 职责 |
|---|---|---|
| `onRightChange()` | 13 | 右通道 PWM 中断捕获 |
| `onLeftChange()` | 13 | 左通道 PWM 中断捕获 |
| `mapToGear()` | 14 | 9 档位模式映射 |
| `mapLinearToEsc()` | 18 | 连续模式线性映射 |
| `mapToEsc()` | 8 | 统一映射入口 |
| `readRcInputs()` | 39 | RC 输入读取与滤波 |

### 流量计 (3 函数, 57 行)

| 函数 | 行数 | 职责 |
|---|---|---|
| `pollFlowSensor()` | 8 | 轻量级轮询 |
| `updateFlowMeter()` | 13 | 多次采样轮询 |
| `calculateFlowData()` | 36 | 流量计算（频率、流速、总量） |

### UDP 通信 (7 函数, 182 行)

| 函数 | 行数 | 职责 |
|---|---|---|
| `sendHeartbeat()` | 13 | 发送心跳到 Jetson |
| `readUdpCommands()` | 81 | 接收 C 命令、速率限制 |
| `checkJetsonStatus()` | 4 | 超时检测在线状态 |
| `sendUdpStatus()` | 17 | 发送 S 状态 (10Hz) |
| `sendUdpFlowData()` | 17 | 发送 F 流量 (5Hz) |
| `determineControlMode()` | 34 | 控制模式切换、衰减 |
| `updateThrusters()` | 4 | ESC 输出更新 |

### WiFi 管理 (3 函数, 238 行)

| 函数 | 行数 | 职责 |
|---|---|---|
| `connectToWiFi()` | 66 | 初始连接（尝试所有网络） |
| `checkWiFiStatus()` | 30 | 定期检查、触发重连 |
| `reconnectWiFi()` | 142 | 优先重连历史网络、尝试备用网络 |

---

## 主循环执行顺序

`loop()` 函数包含 16 个步骤，按优先级顺序执行：

```
序号  函数调用                  说明                          可能阻塞
─────────────────────────────────────────────────────────────
1.   pollFlowSensor()         流量传感器轮询                 否
2.   checkWiFiStatus()        WiFi 状态检查                 是 (2秒间隔)
3.   pollFlowSensor()         WiFi 检查后轮询               否
4.   readRcInputs()           RC 输入读取                   否
5.   readUdpCommands()        UDP 命令读取                  是
6.   pollFlowSensor()         UDP 后轮询 (关键)             否
7.   checkJetsonStatus()      Jetson 在线检查               否
8.   sendHeartbeat()          发送心跳                      是
9.   pollFlowSensor()         心跳后轮询                    否
10.  determineControlMode()   确定控制模式                  否
11.  updateThrusters()        更新推进器                    否
12.  sendUdpStatus()          发送状态 (10Hz)               是
13.  pollFlowSensor()         状态后轮询                    否
14.  sendUdpFlowData()        发送流量 (5Hz)                是
15.  pollFlowSensor()         最终轮询                      否
16.  calculateFlowData()      计算流量数据                  否
17.  连接状态变化检测          WiFi/Jetson 状态变化打印      否
```

### 流量传感器轮询策略

由于 UDP 操作可能阻塞导致丢失流量脉冲，代码采用了 **高频轮询** 策略：

- 每个可能阻塞的操作前后都调用 `pollFlowSensor()`
- 主循环中有 **6 次轮询点**
- 确保 UDP 阻塞期间不会丢失流量数据

---

## UDP 协议

### 端口分配

| 端口 | 方向 | 协议 | 说明 |
|---|---|---|---|
| **8888** | Arduino ← Jetson | C 命令 | 推进器控制命令 |
| **28888** | Arduino → Jetson | S 状态 / F 流量 | 状态和流量数据 |
| **28887** | Arduino → Jetson | HEARTBEAT | 1Hz 心跳 |

### 消息格式

| 类型 | 格式 | 频率 | 说明 |
|---|---|---|---|
| **C 命令** | `C <left_us> <right_us>\n` | 按需 | 推进器控制，速率限制 50Hz |
| **S 状态** | `S <mode> <left_us> <right_us>\n` | 10Hz | mode=0(RC) / 1(WiFi) |
| **F 流量** | `F <freq_hz> <flow_lmin> <velocity_ms> <total_liters>\n` | 5Hz | 流量传感器数据 |
| **HEARTBEAT** | `HEARTBEAT\n` | 1Hz | 在线指示 |

### 超时机制

| 超时类型 | 时长 | 动作 |
|---|---|---|
| RC 信号超时 | 200ms | RC 通道归零（失效保护） |
| UDP 超时 | 2000ms | 切换到 RC 模式 |
| WiFi 优雅期 | 400ms | 衰减到中立（平滑过渡） |

---

## 控制优先级

```
优先级 1: WiFi/UDP 命令
         ↓ (2秒无数据)
优先级 2: RC 接收器
         ↓ (200ms无信号)
优先级 3: 中立失效保护
```

### UDP → RC 切换流程

```
┌─────────────────┐
│  UDP 在线       │  currentMode = 1
│  wifiOutL/R     │  直接控制
└────────┬────────┘
         │ 2秒无命令
         ▼
┌─────────────────┐
│  优雅保持期     │  currentMode = 1
│  400ms 衰减     │  每周期 ±5µs 趋向 1500
└────────┬────────┘
         │ 400ms 后
         ▼
┌─────────────────┐
│  RC 模式        │  currentMode = 0
│  rcOutL/R       │  RC 直接控制
└─────────────────┘
```

---

## 内存使用估算

### 全局变量

| 类别 | 数量 | 每项大小 | 总计 |
|---|---|---|---|
| WiFi 网络配置 | 5 结构体 | ~40 字节 | ~200 字节 |
| UDP 缓冲区 | 2 | 128 + 64 | 192 字节 |
| 状态变量 | ~30 | 4-8 字节 | ~150 字节 |
| **总计** | | | **~550 字节** |

### 堆栈使用

| 函数 | 最大堆栈深度 |
|---|---|
| `loop()` | ~200 字节 |
| `reconnectWiFi()` | ~150 字节 |
| `readUdpCommands()` | ~100 字节 |

---

## 性能特征

| 指标 | 数值 |
|---|---|
| **主循环频率** | ~100-1000 Hz (取决于 UDP 流量) |
| **状态发送率** | 10 Hz |
| **流量数据率** | 5 Hz |
| **心跳频率** | 1 Hz |
| **RC 响应延迟** | < 10ms (中断捕获) |
| **UDP 命令延迟** | ~10-50ms (滤波+斜率限制) |

---

## 代码质量

### 优点
- ✅ 清晰的模块划分
- ✅ 丰富的配置选项
- ✅ 完善的超时保护
- ✅ 多网络自动切换
- ✅ 流量传感器防丢失策略

### 可改进点
- ⚠️ WiFi 管理代码占比过高 (25%)
- ⚠️ `updateFlowMeter()` 函数未被使用
- ⚠️ 流量数据计算中存在冗余赋值 (`flowLmin = flowLmin`)

---

## 版本历史

| 日期 | 版本 | 变更 |
|---|---|---|
| 2026-02-05 | 1.0 | 初始分析 |
