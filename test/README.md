# Arduino 推进器控制测试程序

**[English Version](README_EN.md)** | 中文版本

## 概述

这是一个用于测试和控制双推进器（左/右）的 Arduino 程序。程序从 RC 接收机读取 PWM 信号，经过滤波和安全保护处理后，驱动两个 ESC（电子调速器）控制推进器。

## 硬件连接

### 输入引脚（RC 接收机）
- **Pin 2**: 右通道 PWM 输入（CH_RIGHT_IN）
- **Pin 3**: 左通道 PWM 输入（CH_LEFT_IN）

### 输出引脚（ESC 控制）
- **Pin 9**: 右侧推进器 ESC 输出（ESC_RIGHT_OUT）
- **Pin 10**: 左侧推进器 ESC 输出（ESC_LEFT_OUT）

### 接线要求
1. **共地连接（必须）**: Arduino GND 必须与 RC 接收机 GND 连接
2. **独立供电**: ESC 使用独立电源（电池），不要从 Arduino 5V 供电
3. **信号协议**: 确保 RC 接收机输出标准 PWM 信号（1000-2000µs），而不是 S.BUS/PPM/iBUS 等协议

```
RC 接收机          Arduino         ESC          推进器
┌─────────┐       ┌────────┐      ┌───┐        ┌────┐
│ CH1 ────┼──────→│ Pin 2  │      │   │        │    │
│ CH2 ────┼──────→│ Pin 3  │      │ R │←───────┤ 右 │
│         │       │        │      │   │        │    │
│ GND ────┼───────┤ GND    │      │ L │←───────┤ 左 │
└─────────┘       │ Pin 9  ├─────→│   │        │    │
                  │ Pin 10 ├─────→│   │        │    │
                  └────────┘      └───┘        └────┘
                                   ↑
                              电池供电
```

## 核心功能

### 1. 中断式 PWM 捕获（非阻塞）

**传统问题**: 使用 `pulseIn()` 是阻塞式的，会因等待脉冲而错过其他脉冲或导致采样不连续。

**解决方案**: 使用中断捕获（`attachInterrupt`）：
- 每次引脚电平变化时触发中断
- 上升沿记录时间戳，下降沿计算脉宽
- 非阻塞，不影响主循环其他任务
- 仅接受 800-2200µs 范围的脉宽，拒绝噪声

```cpp
void onRightChange() {
  int level = digitalRead(CH_RIGHT_IN);
  unsigned long now = micros();
  if (level == HIGH) {
    rRiseMicros = now;  // 记录上升沿
  } else {
    unsigned long width = now - rRiseMicros;  // 计算脉宽
    if (width >= 800 && width <= 2200) {
      rPulseMicros = width;  // 保存有效脉宽
    }
  }
}
```

### 2. 信号映射与死区

**输入范围**: 950-2000µs（RC 接收机标准输出）
**输出范围**: 1100-1900µs（ESC 安全工作范围）

**映射规则**:
- 950µs → 1100µs（最小推力）
- 1500µs → 1500µs（停止）
- 2000µs → 1900µs（最大推力）
- < 950µs 或 > 2000µs → 1500µs（故障保护）

**中位死区**:
- 1500±25µs 的输入全部映射到 1500µs
- 消除遥控器中位附近的微小抖动
- 确保推进器在中位时完全停止

```cpp
if (abs((int)inUs - RC_MID) <= DEADBAND_US) return ESC_MID;
```

### 3. 低通滤波

**目的**: 平滑输入信号的高频抖动，避免 ESC 误判信号不稳定。

**实现**: 指数加权移动平均（EWMA）
```cpp
filtL = (avgL * 80 + outL * 20) / 100;  // 20% 新值，80% 旧值
```

**参数**: `FILTER_ALPHA = 20`（百分比）
- 越大：响应越快，但滤波效果越弱
- 越小：更平滑，但响应变慢
- 推荐范围：15-30

### 4. 软启动斜坡限制

**目的**: 防止输出突变导致 ESC 重新解锁或进入保护模式。

**实现**: 限制每个循环周期的最大变化量
```cpp
int deltaL = filtL - avgL;
if (deltaL > MAX_STEP_US) deltaL = MAX_STEP_US;    // 限制加速
if (deltaL < -MAX_STEP_US) deltaL = -MAX_STEP_US;  // 限制减速
avgL += deltaL;
```

**参数**: `MAX_STEP_US = 10`（微秒/循环）
- 在 5ms 循环周期下，从 1100→1900 需要 80 个周期（0.4秒）
- 更大值：响应更快，但可能引起抖动
- 更小值：更平滑，但响应变慢
- 推荐范围：5-20

### 5. 故障保护（Failsafe）

**触发条件**: 超过 200ms 未收到有效 PWM 信号

**保护动作**: 
- 强制输出设为 1500µs（推进器停止）
- 持续监控，恢复信号后自动恢复控制

**应用场景**:
- 遥控器关闭或失联
- 接收机断电
- 信号线松动
- 电磁干扰导致信号丢失

```cpp
if (now - lastUpdateL > FAILSAFE_MS) avgL = ESC_MID;
```

## 参数调优

### 响应速度 vs 稳定性权衡

| 需求 | FILTER_ALPHA | MAX_STEP_US | 效果 |
|------|--------------|-------------|------|
| **快速响应** | 30-40 | 15-20 | 反应灵敏，适合竞速 |
| **平衡** | 20 | 10 | 默认配置，兼顾稳定与响应 |
| **最大稳定性** | 10-15 | 5-8 | 最平滑，适合精密控制 |

### 死区调整

| DEADBAND_US | 适用场景 |
|-------------|----------|
| 15-20 | 高精度遥控器，中位准确 |
| **25** | 默认，适合大多数 RC 系统 |
| 30-40 | 遥控器中位抖动较大 |

## 串口监视器输出

### 输出格式
```
[循环次数] 右(Pin2): XXXµs (状态) | 左(Pin3): XXXµs (状态) | 距上次更新: L=XXms R=XXms | outL|outR=XXXX|XXXX
```

### 状态说明
- **(超时)**: 25ms 内未检测到脉冲
- **(过低)**: 脉宽 < 950µs，信号异常
- **(过高)**: 脉宽 > 2000µs，信号异常
- **(中位)**: 脉宽在 1500±25µs 范围内
- **(后退)**: 脉宽 < 1475µs
- **(前进)**: 脉宽 > 1525µs

### 示例输出
```
[1234] 右(Pin2): 1523µs (中位) | 左(Pin3): 1498µs (中位) | 距上次更新: L=0ms R=0ms | outL|outR=1500|1500
[1235] 右(Pin2): 1678µs (前进) | 左(Pin3): 1682µs (前进) | 距上次更新: L=0ms R=0ms | outL|outR=1510|1510
[1236] 右(Pin2): 1756µs (前进) | 左(Pin3): 1748µs (前进) | 距上次更新: L=0ms R=0ms | outL|outR=1520|1520
```

## 故障排查

### 1. 推进器断断续续旋转

**可能原因**:
- RC 接收机与 Arduino 没有共地 → **连接 GND**
- 接收机输出协议不是 PWM → **检查接收机设置**
- 电源不稳定 → **使用独立稳压电源**

**诊断方法**:
```
// 查看串口输出，如果频繁看到:
距上次更新: L=0ms R=0ms  // 信号正常
距上次更新: L=234ms R=234ms [左通道故障保护] [右通道故障保护]  // 信号丢失
```

### 2. 没有 PWM 输入（一直超时）

**检查清单**:
1. ✓ 接收机是否通电（指示灯亮）
2. ✓ 遥控器是否开启并配对
3. ✓ 信号线是否正确连接到 Pin 2 和 Pin 3
4. ✓ 接收机是否配置为 PWM 输出模式（非 S.BUS/PPM）
5. ✓ Arduino GND 与接收机 GND 是否连接

### 3. 读取到的 PWM 值异常低（<100µs）

**原因**: 检测到高频噪声，而非真实 PWM 信号

**解决方法**:
- 确保共地连接
- 使用屏蔽线或缩短信号线长度
- 检查接收机是否输出正确的 PWM 协议
- 添加电源去耦电容（接收机 VCC/GND 之间）

### 4. 推进器响应太慢

**调整参数**:
```cpp
const int FILTER_ALPHA = 30;    // 增加到 30-40
const int MAX_STEP_US  = 20;    // 增加到 15-20
```

### 5. 推进器抖动严重

**调整参数**:
```cpp
const int FILTER_ALPHA = 10;    // 降低到 10-15
const int MAX_STEP_US  = 5;     // 降低到 5-8
const int DEADBAND_US  = 35;    // 增加到 30-40
```

## ESC 初始化说明

程序启动时会执行 ESC 初始化：
```cpp
escL.writeMicroseconds(ESC_MID);  // 输出 1500µs
escR.writeMicroseconds(ESC_MID);
delay(2000);  // 保持 2 秒
```

**注意事项**:
- 确保 ESC 在收到 1500µs 信号时处于解锁状态
- 某些 ESC 需要特殊解锁程序（高-低-中），请参考 ESC 说明书
- 如需自定义解锁，修改 `setup()` 中的初始化代码

## 技术参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 串口波特率 | 115200 | 用于调试输出 |
| 循环周期 | 5ms | 200Hz 更新频率 |
| PWM 频率 | 50Hz | 标准 RC PWM |
| 中断模式 | CHANGE | 上升沿+下降沿都触发 |
| 滤波时间常数 | ~25ms | 取决于 FILTER_ALPHA |
| 最大斜坡时间 | ~400ms | 从最小到最大（1100→1900µs） |

## 安全注意事项

⚠️ **警告**：推进器具有危险性，请务必遵守以下安全规则：

1. **首次测试**：移除螺旋桨，仅测试电机转动
2. **固定装置**：确保设备牢固固定，防止意外移动
3. **断电操作**：接线时必须断开电源
4. **急停准备**：确保可以随时切断电源或遥控器
5. **周围环境**：测试区域内不要有人或障碍物
6. **水下测试**：如用于水下推进器，先在水缸中测试

## 常见 RC 接收机协议对比

| 协议 | 引脚数 | 频率 | 是否适用本程序 |
|------|--------|------|----------------|
| **PWM** | 每通道1根 | 50Hz | ✅ 适用 |
| PPM | 1根（多通道） | 50Hz | ❌ 不适用 |
| S.BUS | 1根串行 | 100Hz | ❌ 不适用 |
| iBUS | 1根串行 | 50Hz | ❌ 不适用 |
| DSM2/DSMX | 1根串行 | 22ms | ❌ 不适用 |

如果接收机不支持 PWM 输出，需要修改代码以支持相应协议。

## 扩展功能建议

1. **添加第三个通道**: 用于模式切换或速度限制
2. **限速功能**: 限制最大推力百分比
3. **混控模式**: 实现差速转向控制
4. **数据记录**: 保存运行数据到 SD 卡
5. **无线遥测**: 通过蓝牙/WiFi 发送状态信息

## 许可证

本项目基于 Arduino 推进器控制系统开发，仅供学习和测试使用。

## 版本历史

- **v1.0** (2025-12-12): 初始版本
  - 中断式 PWM 捕获
  - 低通滤波与软启动
  - 中位死区与故障保护
  - 详细串口调试输出

---

**作者**: Arduino 推进器控制项目组  
**最后更新**: 2025年12月12日
